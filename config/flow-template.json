{
  "name": "${FLOW_NAME}",
  "description": "${FLOW_DESCRIPTION}",
  "executionRoleArn": "arn:aws:iam::${AWS_ACCOUNT_ID}:role/${EXECUTION_ROLE_NAME}",
  "definition": {
    "nodes": [
      {
        "name": "InputNode",
        "type": "Input",
        "configuration": {
          "input": {}
        },
        "outputs": [
          {
            "name": "document",
            "type": "String"
          }
        ]
      },
      {
        "name": "LogAnalyzer",
        "type": "Prompt",
        "configuration": {
          "prompt": {
            "sourceConfiguration": {
              "inline": {
                "templateType": "TEXT",
                "templateConfiguration": {
                  "text": {
                    "text": "ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆãƒ­ã‚°ã‚’åˆ†æã—ã€ã‚¨ãƒ©ãƒ¼ã¨è­¦å‘Šã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚\n\nãƒ­ã‚°å†…å®¹:\n{{log_content}}\n\nä»¥ä¸‹ã®å½¢å¼ã§JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„:\n{\n  \"errors\": [\n    {\n      \"type\": \"ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—\",\n      \"message\": \"ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸\",\n      \"line\": \"è©²å½“è¡Œ\",\n      \"severity\": \"Critical|High|Medium|Low\"\n    }\n  ],\n  \"warnings\": [\n    {\n      \"type\": \"è­¦å‘Šã‚¿ã‚¤ãƒ—\",\n      \"message\": \"è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸\",\n      \"line\": \"è©²å½“è¡Œ\"\n    }\n  ],\n  \"summary\": {\n    \"total_errors\": æ•°å€¤,\n    \"total_warnings\": æ•°å€¤,\n    \"critical_issues\": æ•°å€¤,\n    \"failed_tests\": [\"ãƒ†ã‚¹ãƒˆåã®ãƒªã‚¹ãƒˆ\"]\n  },\n  \"key_issues\": \"æœ€ã‚‚é‡è¦ãªå•é¡Œã®è¦ç´„ï¼ˆ200æ–‡å­—ä»¥å†…ï¼‰\"\n}",
                    "inputVariables": [
                      {"name": "log_content"}
                    ]
                  }
                },
                "modelId": "${BEDROCK_MODEL_ID}",
                "inferenceConfiguration": {
                  "text": {
                    "maxTokens": ${MAX_TOKENS_ANALYZER},
                    "temperature": ${TEMPERATURE},
                    "topP": ${TOP_P}
                  }
                }
              }
            }
          }
        },
        "inputs": [
          {
            "expression": "$.data",
            "name": "log_content",
            "type": "String"
          }
        ],
        "outputs": [
          {
            "name": "modelCompletion",
            "type": "String"
          }
        ]
      },
      {
        "name": "SeverityClassifier",
        "type": "Condition",
        "configuration": {
          "condition": {
            "conditions": [
              {
                "name": "Critical",
                "expression": "$.data.contains('FATAL') || $.data.contains('Critical')"
              },
              {
                "name": "High",
                "expression": "$.data.contains('ERROR') || $.data.contains('Exception')"
              },
              {
                "name": "Medium",
                "expression": "$.data.contains('WARN') || $.data.contains('Timeout')"
              },
              {
                "name": "Low",
                "expression": "true"
              }
            ]
          }
        },
        "inputs": [
          {
            "expression": "$.data",
            "name": "data",
            "type": "String"
          }
        ],
        "outputs": [
          {
            "name": "conditionName",
            "type": "String"
          }
        ]
      },
      {
        "name": "ErrorExtractor",
        "type": "Prompt",
        "configuration": {
          "prompt": {
            "sourceConfiguration": {
              "inline": {
                "templateType": "TEXT",
                "templateConfiguration": {
                  "text": {
                    "text": "ä»¥ä¸‹ã®åˆ†æçµæœã‹ã‚‰ã€æœ€ã‚‚é‡è¦ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚\n\nåˆ†æçµæœ:\n{{analysis_result}}\n\nä»¥ä¸‹ã®æ¡ä»¶ã§æŠ½å‡ºã—ã¦ãã ã•ã„:\n1. FATALã‚„ERRORãƒ¬ãƒ™ãƒ«ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å„ªå…ˆ\n2. ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã¯æœ€åˆã®10è¡Œã¾ã§\n3. é‡è¤‡ã™ã‚‹ã‚¨ãƒ©ãƒ¼ã¯é™¤å¤–\n4. ãƒ†ã‚¹ãƒˆå¤±æ•—ã®ç›´æ¥çš„ãªåŸå› ã¨ãªã‚‹ã‚¨ãƒ©ãƒ¼ã‚’é‡è¦–\n\nå‡ºåŠ›å½¢å¼:\n```\nã€é‡è¦ãªã‚¨ãƒ©ãƒ¼1ã€‘\nã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—: \nãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: \nã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹: \n\nã€é‡è¦ãªã‚¨ãƒ©ãƒ¼2ã€‘\n...\n```",
                    "inputVariables": [
                      {"name": "analysis_result"}
                    ]
                  }
                },
                "modelId": "${BEDROCK_MODEL_ID}",
                "inferenceConfiguration": {
                  "text": {
                    "maxTokens": ${MAX_TOKENS_EXTRACTOR},
                    "temperature": ${TEMPERATURE},
                    "topP": ${TOP_P}
                  }
                }
              }
            }
          }
        },
        "inputs": [
          {
            "expression": "$.data",
            "name": "analysis_result",
            "type": "String"
          }
        ],
        "outputs": [
          {
            "name": "modelCompletion",
            "type": "String"
          }
        ]
      },
      {
        "name": "KnowledgeBaseSearch",
        "type": "KnowledgeBase",
        "configuration": {
          "knowledgeBase": {
            "knowledgeBaseId": "${KNOWLEDGE_BASE_ID}",
            "modelId": "${BEDROCK_MODEL_ID}"
          }
        },
        "inputs": [
          {
            "expression": "$.data",
            "name": "retrievalQuery",
            "type": "String"
          }
        ],
        "outputs": [
          {
            "name": "outputText",
            "type": "String"
          }
        ]
      },
      {
        "name": "ReportGenerator",
        "type": "Prompt",
        "configuration": {
          "prompt": {
            "sourceConfiguration": {
              "inline": {
                "templateType": "TEXT",
                "templateConfiguration": {
                  "text": {
                    "text": "ä»¥ä¸‹ã®æƒ…å ±ã‚’çµ±åˆã—ã¦ã€ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœã®åŒ…æ‹¬çš„ãªã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆã‚’Markdownå½¢å¼ã§ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚\n\n## å…¥åŠ›ãƒ‡ãƒ¼ã‚¿\n- **ãƒ­ã‚°åˆ†æçµæœ**: {{analysis_result}}\n- **é‡è¦åº¦ãƒ¬ãƒ™ãƒ«**: {{severity_level}}\n- **æŠ½å‡ºã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼**: {{extracted_errors}}\n- **æ ¹æœ¬åŸå› åˆ†æ**: {{root_cause_analysis}}\n\n## å‡ºåŠ›å½¢å¼\nä»¥ä¸‹ã®Markdownå½¢å¼ã§çµ±ä¸€ã•ã‚ŒãŸãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„:\n\n# ğŸ” ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ\n\n**ç”Ÿæˆæ—¥æ™‚**: [ç¾åœ¨æ™‚åˆ»]\n**é‡è¦åº¦**: {{severity_level}}\n\n## ğŸ“Š å®Ÿè¡Œæ¦‚è¦\n\n| é …ç›® | å€¤ |\n|------|----|\n| ç·ã‚¨ãƒ©ãƒ¼æ•° | [åˆ†æçµæœã‹ã‚‰æŠ½å‡º] |\n| ç·è­¦å‘Šæ•° | [åˆ†æçµæœã‹ã‚‰æŠ½å‡º] |\n| å¤±æ•—ãƒ†ã‚¹ãƒˆæ•° | [åˆ†æçµæœã‹ã‚‰æŠ½å‡º] |\n| é‡è¦åº¦ | {{severity_level}} |\n\n## ğŸš¨ é‡è¦ãªå•é¡Œ\n\n{{extracted_errors}}\n\n## ğŸ” æ ¹æœ¬åŸå› åˆ†æ\n\n{{root_cause_analysis}}\n\n## ğŸ“ˆ å½±éŸ¿åº¦è©•ä¾¡\n\n- **ã‚·ã‚¹ãƒ†ãƒ å½±éŸ¿**: [Critical/High/Medium/Low]\n- **ãƒ¦ãƒ¼ã‚¶ãƒ¼å½±éŸ¿**: [åˆ†æçµæœã«åŸºã¥ãè©•ä¾¡]\n- **ãƒ“ã‚¸ãƒã‚¹å½±éŸ¿**: [æ¨å®šã•ã‚Œã‚‹å½±éŸ¿]\n\n## ğŸ’¡ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³\n\n### ğŸ”¥ ç·Šæ€¥å¯¾å¿œï¼ˆ24æ™‚é–“ä»¥å†…ï¼‰\n- [æœ€å„ªå…ˆã§å¯¾å¿œã™ã¹ãé …ç›®]\n\n### âš¡ çŸ­æœŸå¯¾å¿œï¼ˆ1é€±é–“ä»¥å†…ï¼‰\n- [çŸ­æœŸã§å¯¾å¿œã™ã¹ãé …ç›®]\n\n### ğŸ”§ ä¸­é•·æœŸå¯¾å¿œï¼ˆ1ãƒ¶æœˆä»¥å†…ï¼‰\n- [ç¶™ç¶šçš„æ”¹å–„é …ç›®]\n\n## ğŸ“‹ æ¬¡å›ãƒ†ã‚¹ãƒˆæ™‚ã®æ³¨æ„ç‚¹\n\n- [äºˆé˜²ç­–ã‚„ç›£è¦–ãƒã‚¤ãƒ³ãƒˆ]\n\n---\n*ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯Amazon Bedrock Flowsã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*",
                    "inputVariables": [
                      {"name": "analysis_result"},
                      {"name": "severity_level"},
                      {"name": "extracted_errors"},
                      {"name": "root_cause_analysis"}
                    ]
                  }
                },
                "modelId": "${BEDROCK_MODEL_ID}",
                "inferenceConfiguration": {
                  "text": {
                    "maxTokens": ${MAX_TOKENS_REPORT},
                    "temperature": ${TEMPERATURE},
                    "topP": ${TOP_P}
                  }
                }
              }
            }
          }
        },
        "inputs": [
          {
            "expression": "$.data.analysis",
            "name": "analysis_result",
            "type": "String"
          },
          {
            "expression": "$.data.severity",
            "name": "severity_level",
            "type": "String"
          },
          {
            "expression": "$.data.errors",
            "name": "extracted_errors",
            "type": "String"
          },
          {
            "expression": "$.data.rootcause",
            "name": "root_cause_analysis",
            "type": "String"
          }
        ],
        "outputs": [
          {
            "name": "modelCompletion",
            "type": "String"
          }
        ]
      },
      {
        "name": "OutputNode",
        "type": "Output",
        "configuration": {
          "output": {}
        },
        "inputs": [
          {
            "expression": "$.data",
            "name": "document",
            "type": "String"
          }
        ]
      }
    ],
    "connections": [
      {
        "name": "InputToAnalyzer",
        "type": "Data",
        "source": "InputNode",
        "target": "LogAnalyzer",
        "configuration": {
          "data": {
            "sourceOutput": "document",
            "targetInput": "log_content"
          }
        }
      },
      {
        "name": "AnalyzerToClassifier",
        "type": "Data",
        "source": "LogAnalyzer",
        "target": "SeverityClassifier",
        "configuration": {
          "data": {
            "sourceOutput": "modelCompletion",
            "targetInput": "data"
          }
        }
      },
      {
        "name": "AnalyzerToExtractor",
        "type": "Data",
        "source": "LogAnalyzer",
        "target": "ErrorExtractor",
        "configuration": {
          "data": {
            "sourceOutput": "modelCompletion",
            "targetInput": "analysis_result"
          }
        }
      },
      {
        "name": "ExtractorToKnowledgeBase",
        "type": "Data",
        "source": "ErrorExtractor",
        "target": "KnowledgeBaseSearch",
        "configuration": {
          "data": {
            "sourceOutput": "modelCompletion",
            "targetInput": "retrievalQuery"
          }
        }
      },
      {
        "name": "AllToReportGenerator",
        "type": "Data",
        "source": "KnowledgeBaseSearch",
        "target": "ReportGenerator",
        "configuration": {
          "data": {
            "sourceOutput": "outputText",
            "targetInput": "root_cause_analysis"
          }
        }
      },
      {
        "name": "ReportToOutput",
        "type": "Data",
        "source": "ReportGenerator",
        "target": "OutputNode",
        "configuration": {
          "data": {
            "sourceOutput": "modelCompletion",
            "targetInput": "document"
          }
        }
      }
    ]
  }
}